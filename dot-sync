#!/bin/bash
set -exo pipefail

CURRENT_COMMAND=""
ERROR_LOG="$(mktemp)"

function notify_on_error {
  notify-send --app-name="dot-sync" \
    "Failed to sync dotfiles." \
    "$(cat "$ERROR_LOG" | tr '\n' ' ' | tr -s '[:space:]')"
}

trap 'notify_on_error' EXIT

cd "$HOME" 2> "$ERROR_LOG"
git pull -q origin master 2> "$ERROR_LOG"
pacman -Qqs > .arch.conf 2> "$ERROR_LOG"
if [ -n "$(git status --short)" ]; then
  git commit --quiet -am "Auto-sync $(/usr/bin/date)" 2> "$ERROR_LOG"
fi
git push -q origin master > /dev/null 2> "$ERROR_LOG"

trap - EXIT
